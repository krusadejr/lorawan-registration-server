{% extends "base.html" %}

{% block title %}Registrierung - Vorschau{% endblock %}

{% block content %}
<div class="columns is-centered">
    <div class="column is-four-fifths">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="notification is-{{ category }} dark-notification">
                    <button class="delete"></button>
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="box dark-box">
            <h1 class="title is-3 has-text-light">
                <i class="fas fa-clipboard-check"></i>
                Registrierung - Vorschau & Best√§tigung
            </h1>
            <p class="subtitle is-6 has-text-grey-light">
                √úberpr√ºfen Sie die Daten vor der Registrierung bei ChirpStack
            </p>

            <!-- Summary Box -->
            <div class="notification is-info dark-notification mb-5">
                <div class="columns">
                    <div class="column">
                        <p><strong><i class="fas fa-file mr-2"></i>Datei:</strong> {{ filename }}</p>
                    </div>
                    <div class="column">
                        <p><strong><i class="fas fa-microchip mr-2"></i>Anzahl Ger√§te:</strong> {{ device_count }}</p>
                    </div>
                </div>
            </div>

            <!-- Data Audit / Validation Report -->
            {% if data_audit and (data_audit.warnings or data_audit.statistics) %}
            <div class="notification is-dark mb-5">
                <h3 class="subtitle is-5 has-text-light">
                    <i class="fas fa-clipboard-list"></i>
                    Datenvalidierungsbericht
                </h3>
                
                <div class="columns is-multiline">
                    <div class="column is-one-quarter">
                        <div class="box" style="background-color: #2b3d3a; text-align: center;">
                            <p class="heading">Gesamt</p>
                            <p class="title is-4">{{ data_audit.statistics.total_devices }}</p>
                        </div>
                    </div>
                    <div class="column is-one-quarter">
                        <div class="box" style="background-color: {% if data_audit.statistics.devices_with_empty_keys > 0 %}#4a3a2a{% else %}#2b3d3a{% endif %}; text-align: center;">
                            <p class="heading">Ohne NwkKey</p>
                            <p class="title is-4 {% if data_audit.statistics.devices_with_empty_keys > 0 %}has-text-warning{% endif %}">{{ data_audit.statistics.devices_with_empty_keys }}</p>
                        </div>
                    </div>
                    <div class="column is-one-quarter">
                        <div class="box" style="background-color: {% if data_audit.statistics.devices_with_invalid_eui > 0 %}#4a3a2a{% else %}#2b3d3a{% endif %}; text-align: center;">
                            <p class="heading">Ung√ºltige EUI</p>
                            <p class="title is-4 {% if data_audit.statistics.devices_with_invalid_eui > 0 %}has-text-warning{% endif %}">{{ data_audit.statistics.devices_with_invalid_eui }}</p>
                        </div>
                    </div>
                    <div class="column is-one-quarter">
                        <div class="box" style="background-color: {% if data_audit.statistics.devices_with_invalid_keys > 0 %}#4a3a2a{% else %}#2b3d3a{% endif %}; text-align: center;">
                            <p class="heading">Ung√ºltige Keys</p>
                            <p class="title is-4 {% if data_audit.statistics.devices_with_invalid_keys > 0 %}has-text-warning{% endif %}">{{ data_audit.statistics.devices_with_invalid_keys }}</p>
                        </div>
                    </div>
                    {% if data_audit.statistics.get('devices_with_invalid_profile_id', 0) > 0 %}
                    <div class="column is-one-quarter">
                        <div class="box" style="background-color: #4a3a2a; text-align: center;">
                            <p class="heading">Ung√ºltige Profile ID</p>
                            <p class="title is-4 has-text-warning">{{ data_audit.statistics.devices_with_invalid_profile_id }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if data_audit.warnings %}
                <div class="mt-4">
                    <h4 class="subtitle is-6 has-text-warning">‚ö†Ô∏è Erkannte Probleme:</h4>
                    {% for warning in data_audit.warnings %}
                    <div class="box" style="background-color: #3a3a2a; border-left: 3px solid #ffdd57;">
                        <p class="has-text-light">{{ warning }}</p>
                    </div>
                    {% endfor %}
                    <p class="help has-text-grey-light mt-3">Bitte √ºberpr√ºfen Sie die Spaltenauswahl auf der Spalten-Zuordnungsseite.</p>
                </div>
                {% else %}
                <div class="mt-4">
                    <p class="has-text-success">‚úì Daten sehen gut aus!</p>
                </div>
                {% endif %}

                <!-- Device Profile IDs Section -->
                {% if data_audit and data_audit.unique_profile_ids %}
                <div class="mt-5" style="border-top: 1px solid #444; padding-top: 1.5rem;">
                    <h4 class="subtitle is-6 has-text-light mb-3">üìã Device Profile IDs (werden f√ºr alle Ger√§te verwendet):</h4>
                    {% for profile_id in data_audit.unique_profile_ids %}
                    <div class="box" style="background-color: #2a2a3e; border-left: 4px solid #ffdd57;">
                        <code class="has-text-warning" style="word-break: break-all; font-size: 0.9em;">{{ profile_id }}</code>
                        <p class="help has-text-grey-light mt-2">Bitte stellen Sie sicher, dass diese ID in Ihrer ChirpStack-Instanz existiert</p>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Server Configuration Check -->
            {% if server_configured %}
                <div class="notification is-success dark-notification mb-5">
                    <h3 class="subtitle is-5 has-text-light">
                        <i class="fas fa-check-circle"></i>
                        Server-Konfiguration
                    </h3>
                    <div class="content has-text-light">
                        <ul>
                            <li><strong>Server URL:</strong> <code>{{ server_url }}</code></li>
                            <li><strong>Tenant ID:</strong> <code>{{ tenant_id }}</code></li>
                            <li><strong>API Key:</strong> <code>‚úì Konfiguriert</code></li>
                        </ul>
                    </div>
                </div>
            {% else %}
                <div class="notification is-danger dark-notification mb-5">
                    <h3 class="subtitle is-5 has-text-light">
                        <i class="fas fa-exclamation-triangle"></i>
                        Server nicht konfiguriert!
                    </h3>
                    <p class="mb-3">Bitte konfigurieren Sie zuerst die Server-Verbindung.</p>
                    <a href="{{ url_for('server_config') }}" class="button is-danger">
                        <span class="icon">
                            <i class="fas fa-cog"></i>
                        </span>
                        <span>Server jetzt konfigurieren</span>
                    </a>
                </div>
            {% endif %}

            <!-- Device Preview -->
            <div class="notification is-dark mb-5">
                <h3 class="subtitle is-5 has-text-light">
                    <i class="fas fa-eye"></i>
                    Ger√§te-Vorschau (erste 10 Ger√§te)
                </h3>
                <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                    {{ preview_html|safe }}
                </div>
                {% if device_count > 10 %}
                    <p class="help has-text-grey-light mt-3">
                        <i class="fas fa-info-circle"></i>
                        Zeige 10 von {{ device_count }} Ger√§ten. Alle Ger√§te werden registriert.
                    </p>
                {% endif %}
            </div>

            <!-- Custom Tags Section -->
            <div class="box" style="background-color: #1a1a2e; border: 1px solid #16a34a; margin-bottom: 1.5rem;">
                <h3 class="subtitle is-5 has-text-light">
                    <i class="fas fa-tags"></i>
                    Benutzerdefinierte Tags (Optional - max. 4)
                </h3>
                <p class="has-text-grey-light mb-4">Diese Tags werden auf <strong>alle Ger√§te</strong> angewendet:</p>
                
                <div id="tagsContainer">
                    <div class="tag-row mb-3">
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <label class="label has-text-grey-light is-small">Tag Name</label>
                                <input type="text" class="input dark-input tag-name" placeholder="z.B. Abteilung" maxlength="50">
                            </div>
                            <div class="control is-expanded ml-3">
                                <label class="label has-text-grey-light is-small">Tag Wert</label>
                                <input type="text" class="input dark-input tag-value" placeholder="z.B. IT-Team" maxlength="100">
                            </div>
                            <div class="control">
                                <label class="label" style="color: transparent;">Spacer</label>
                                <button type="button" class="button is-danger is-outlined remove-tag" style="display: none;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="field">
                    <div class="control">
                        <button type="button" id="addTagBtn" class="button is-info is-outlined">
                            <span class="icon">
                                <i class="fas fa-plus"></i>
                            </span>
                            <span>Tag hinzuf√ºgen</span>
                        </button>
                    </div>
                </div>
                
                <p class="help has-text-grey-light">
                    <i class="fas fa-info-circle"></i>
                    Tags helfen bei der Verwaltung und Organisation Ihrer Ger√§te in ChirpStack.
                </p>
            </div>

            <!-- Registration Warning -->
            <div class="notification is-warning dark-notification mb-5">
                <h3 class="subtitle is-5 has-text-dark">
                    <i class="fas fa-exclamation-triangle"></i>
                    ‚ö†Ô∏è Kritische √úberpr√ºfungen vor der Registrierung
                </h3>
                <div class="content has-text-dark">
                    <ul>
                        <li><strong>Device Profile ID √ºberpr√ºfen:</strong> Stellen Sie sicher, dass die oben angezeigten Device Profile ID(s) in Ihrer ChirpStack-Instanz existieren. Wenn diese ID nicht existiert, schlagen alle Registrierungen fehl!</li>
                        <li><strong>Application ID √ºberpr√ºfen:</strong> √úberpr√ºfen Sie, dass die Application in ChirpStack existiert und Sie Zugriff darauf haben</li>
                        <li><strong>Eindeutige DevEUIs:</strong> Alle Ger√§te-EUIs m√ºssen eindeutig sein (keine Duplikate)</li>
                        <li><strong>Netzwerk- und Anwendungsschl√ºssel:</strong> √úberpr√ºfen Sie, dass alle erforderlichen Schl√ºssel vorhanden sind</li>
                        <li><strong>Nicht r√ºckg√§ngig zu machen:</strong> Der Registrierungsprozess kann nicht r√ºckg√§ngig gemacht werden</li>
                        <li><strong>Fehler-Logging:</strong> Bei Fehlern werden alle Details im Log gespeichert</li>
                    </ul>
                </div>
            </div>

            <!-- Action Buttons -->
            <form method="POST" action="{{ url_for('start_registration') }}" id="registrationForm">
                <!-- Hidden input for custom tags (JSON) -->
                <input type="hidden" id="customTagsInput" name="custom_tags" value="{}">
                
                <!-- Duplicate Handling Options -->
                <div class="box" style="background-color: #1a1a2e; border: 1px solid #3273dc; margin-bottom: 1.5rem;">
                    <h3 class="subtitle is-5 has-text-light">
                        <i class="fas fa-copy"></i>
                        Duplikat-Behandlung
                    </h3>
                    <p class="has-text-grey-light mb-3">Was soll passieren, wenn ein Ger√§t bereits existiert?</p>
                    <div class="field">
                        <div class="control">
                            <label class="radio has-text-light">
                                <input type="radio" name="duplicate_action" value="skip" checked>
                                <strong>√úberspringen</strong> - Ger√§t nicht registrieren, Fehler anzeigen (empfohlen)
                            </label>
                        </div>
                        <div class="control">
                            <label class="radio has-text-light">
                                <input type="radio" name="duplicate_action" value="replace">
                                <strong>Ersetzen</strong> - Vorhandenes Ger√§t l√∂schen und neu registrieren
                            </label>
                        </div>
                    </div>
                    <p class="help has-text-grey-light">
                        <i class="fas fa-info-circle"></i>
                        Bei "√úberspringen" werden existierende Ger√§te ignoriert. Bei "Ersetzen" werden sie gel√∂scht und mit den neuen Daten neu erstellt.
                    </p>
                </div>
                
                <!-- LoRaWAN Version Selection -->
                <div class="box" style="background-color: #1a1a2e; border: 1px solid #48c774; margin-bottom: 1.5rem;">
                    <h3 class="subtitle is-5 has-text-light">
                        <i class="fas fa-microchip"></i>
                        LoRaWAN Version
                    </h3>
                    <p class="has-text-grey-light mb-3">W√§hlen Sie die LoRaWAN-Version Ihrer Ger√§teprofile. Dies ist wichtig f√ºr die korrekte Zuordnung der Schl√ºssel!</p>
                    <div class="field">
                        <label class="label has-text-light">Ger√§te-LoRaWAN-Version:</label>
                        <div class="control is-expanded">
                            <div class="select is-fullwidth dark-select">
                                <select name="lorawan_version" id="lorawanVersion" required>
                                    {% for version in lorawan_versions %}
                                        <option value="{{ version.value }}" {% if version.value == selected_lorawan_version %}selected{% endif %}>
                                            {{ version.label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="message is-info">
                        <div class="message-body has-text-dark">
                            <p><strong>üí° Hinweis:</strong> Sie k√∂nnen die LoRaWAN-Version in ChirpStack unter "Device Profiles" ‚Üí "MAC Version" sehen.</p>
                            <ul class="mt-2" style="margin-left: 20px;">
                                <li>Versionen 1.0.0 - 1.0.4: AppKey geht in das nwk_key Feld</li>
                                <li>Version 1.1.0: AppKey geht in das app_key Feld</li>
                            </ul>
                        </div>
                    </div>
                    <p class="help has-text-grey-light mt-3">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Falls nicht sicher:</strong> Schauen Sie in Ihrem ChirpStack nach, welche MAC Version Ihre Device Profile haben.
                    </p>
                </div>
                
                <div class="field is-grouped is-grouped-centered">
                    <div class="control">
                        <a href="{{ url_for('index') }}" class="button is-light is-large">
                            <span class="icon">
                                <i class="fas fa-times"></i>
                            </span>
                            <span>Abbrechen</span>
                        </a>
                    </div>
                    <div class="control">
                        {% if server_configured %}
                            <button type="submit" class="button is-success is-large" id="registerBtn">
                                <span class="icon">
                                    <i class="fas fa-rocket"></i>
                                </span>
                                <span>{{ device_count }} Ger√§te jetzt registrieren</span>
                            </button>
                        {% else %}
                            <button type="button" class="button is-success is-large" disabled>
                                <span class="icon">
                                    <i class="fas fa-rocket"></i>
                                </span>
                                <span>Registrierung (Server nicht konfiguriert)</span>
                            </button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>

        <!-- Progress Info -->
        <div class="notification is-info dark-notification">
            <h3 class="subtitle is-5 has-text-light">
                <i class="fas fa-info-circle"></i>
                Was passiert bei der Registrierung?
            </h3>
            <div class="content has-text-light">
                <ol>
                    <li><strong>Verbindung aufbauen</strong> - Verbindung zum ChirpStack gRPC Server herstellen</li>
                    <li><strong>Validierung</strong> - DevEUIs und Keys auf korrektes Format pr√ºfen</li>
                    <li><strong>Ger√§te erstellen</strong> - Jedes Ger√§t via gRPC API in ChirpStack registrieren</li>
                    <li><strong>Keys setzen</strong> - Network Key und App Key (falls vorhanden) zuweisen</li>
                    <li><strong>Ergebnis anzeigen</strong> - Erfolgreiche und fehlgeschlagene Registrierungen anzeigen</li>
                </ol>
                <p class="mt-3">
                    <i class="fas fa-clock"></i>
                    <strong>Gesch√§tzte Dauer:</strong> ~{{ (device_count * 0.5)|round(1) }} Sekunden f√ºr {{ device_count }} Ger√§te
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // Handle notification close buttons
    document.addEventListener('DOMContentLoaded', () => {
        (document.querySelectorAll('.notification .delete') || []).forEach(($delete) => {
            const $notification = $delete.parentNode;
            $delete.addEventListener('click', () => {
                $notification.parentNode.removeChild($notification);
            });
        });

        // Add confirmation dialog
        const registerBtn = document.getElementById('registerBtn');
        if (registerBtn) {
            registerBtn.addEventListener('click', (e) => {
                const deviceCount = {{ device_count }};
                if (!confirm(`Sind Sie sicher, dass Sie ${deviceCount} Ger√§te registrieren m√∂chten?\n\nDieser Vorgang kann nicht r√ºckg√§ngig gemacht werden.`)) {
                    e.preventDefault();
                }
            });
        }

        // Custom tags functionality
        const addTagBtn = document.getElementById('addTagBtn');
        const tagsContainer = document.getElementById('tagsContainer');
        const registrationForm = document.getElementById('registrationForm');
        const customTagsInput = document.getElementById('customTagsInput');

        function updateRemoveButtons() {
            const tagRows = tagsContainer.querySelectorAll('.tag-row');
            tagRows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-tag');
                removeBtn.style.display = tagRows.length > 1 ? 'block' : 'none';
            });
        }

        function collectTags() {
            const tags = {};
            const tagRows = tagsContainer.querySelectorAll('.tag-row');
            let count = 0;
            
            tagRows.forEach(row => {
                const name = row.querySelector('.tag-name').value.trim();
                const value = row.querySelector('.tag-value').value.trim();
                
                if (name && value) {
                    tags[name] = value;
                    count++;
                }
            });
            
            return { tags, count };
        }

        // Add tag row
        addTagBtn.addEventListener('click', () => {
            const { count } = collectTags();
            
            if (count >= 4) {
                alert('Maximum 4 Tags erlaubt!');
                return;
            }

            const newRow = document.createElement('div');
            newRow.className = 'tag-row mb-3';
            newRow.innerHTML = `
                <div class="field is-grouped">
                    <div class="control is-expanded">
                        <input type="text" class="input dark-input tag-name" placeholder="z.B. Abteilung" maxlength="50">
                    </div>
                    <div class="control is-expanded ml-3">
                        <input type="text" class="input dark-input tag-value" placeholder="z.B. IT-Team" maxlength="100">
                    </div>
                    <div class="control">
                        <button type="button" class="button is-danger is-outlined remove-tag">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            tagsContainer.appendChild(newRow);
            updateRemoveButtons();
            
            // Add remove event listener
            newRow.querySelector('.remove-tag').addEventListener('click', (e) => {
                e.preventDefault();
                newRow.remove();
                updateRemoveButtons();
            });
        });

        // Remove tag row
        tagsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-tag')) {
                e.preventDefault();
                e.target.closest('.tag-row').remove();
                updateRemoveButtons();
            }
        });

        // Collect tags before form submission
        registrationForm.addEventListener('submit', (e) => {
            const { tags, count } = collectTags();
            
            if (count > 4) {
                e.preventDefault();
                alert('Maximum 4 Tags erlaubt!');
                return;
            }
            
            customTagsInput.value = JSON.stringify(tags);
        });

        // Initial update
        updateRemoveButtons();
    });
</script>
{% endblock %}
